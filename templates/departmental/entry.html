{% extends 'base.html' %}

{% block title %}Departmental Data - Academic Achievement Summarizer{% endblock %}

{% block page_title %}Departmental Data Entry{% endblock %}

{% block extra_css %}
<style>
    .dept-table { font-size: 14px; width: 100%; }
    .dept-table th { white-space: nowrap; text-align: center; padding: 8px; }
    .dept-table td { text-align: center; padding: 8px; }
    .dept-table td:first-child { text-align: left; }
    .dept-table input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
    .dept-table input[type="number"] { width: 60px; text-align: center; }
    .section-header { background: #34495e; color: white; }
    .points-cell { font-weight: bold; color: #27ae60; }
    .note { font-size: 11px; color: #666; display: block; }
    .dept-badge {
        background: #f39c12;
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: normal;
        margin-left: 4px;
        vertical-align: middle;
    }
    .points-legend {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 12px 15px;
        margin-bottom: 20px;
        font-size: 13px;
    }
    .points-legend strong { color: #2c3e50; }
    .points-legend .divider { color: #ccc; margin: 0 8px; }
</style>
{% endblock %}

{% block content %}
<p style="color: #666; margin-bottom: 15px;">
    These items are tracked by the department (not self-reported). Mark all applicable items for each faculty member.
    <span class="dept-badge">DEPT</span> = Department-tracked activity
</p>

<div class="points-legend">
    <strong>Point Values:</strong>
    New Innovations: {{ point_values.new_innovations|default:2000 }}
    <span class="divider">|</span>
    MyTIP Winner: {{ point_values.mytip_winner|default:250 }}
    <span class="divider">|</span>
    MyTIP Count: {{ point_values.mytip_per|default:25 }}/ea (max 20)
    <span class="divider">|</span>
    Top 25%: {{ point_values.teaching_top_25|default:2500 }}
    <span class="divider">|</span>
    65-25%: {{ point_values.teaching_65_25|default:1000 }}
    <span class="divider">|</span>
    Teacher of Year: {{ point_values.teacher_of_year|default:7500 }}
    <span class="divider">|</span>
    Hon. Mention: {{ point_values.honorable_mention|default:5000 }}
    <span class="divider">|</span>
    CCC Member: {{ point_values.ccc_member|default:1000 }}
</div>

<table class="dept-table">
    <thead>
        <tr class="section-header">
            <th rowspan="2" style="text-align: left;">Faculty</th>
            <th rowspan="2" style="white-space: nowrap;">AVC</th>
            <th colspan="3">Evaluations <span class="dept-badge">DEPT</span></th>
            <th colspan="4">Teaching Awards <span class="dept-badge">DEPT</span></th>
            <th rowspan="2">CCC <span class="dept-badge">DEPT</span></th>
            <th rowspan="2">Dept Total</th>
        </tr>
        <tr>
            <th>New Innov<span class="note">(80%+)</span></th>
            <th>MyTIP Win</th>
            <th>MyTIP #<span class="note">(max 20)</span></th>
            <th>Top 25%</th>
            <th>65-25%</th>
            <th>ToY</th>
            <th>Hon Men</th>
        </tr>
    </thead>
    <tbody>
        {% for d in dept_data %}
        <tr data-email="{{ d.faculty.email }}">
            <td style="text-align: left;">
                <a href="{% url 'faculty_detail' d.faculty.email %}">{{ d.faculty.display_name }}</a>
            </td>
            <td>
                <input type="checkbox" class="dept-checkbox" data-field="is_avc_eligible"
                       {% if d.faculty.is_avc_eligible %}checked{% endif %}>
            </td>
            <td>
                <input type="checkbox" class="dept-checkbox" data-field="new_innovations"
                       {% if d.new_innovations %}checked{% endif %}>
            </td>
            <td>
                <input type="checkbox" class="dept-checkbox" data-field="mytip_winner"
                       {% if d.mytip_winner %}checked{% endif %}>
            </td>
            <td>
                <input type="number" class="dept-number" data-field="mytip_count"
                       value="{{ d.mytip_count }}" min="0" max="20">
            </td>
            <td>
                <input type="checkbox" class="dept-checkbox" data-field="teaching_top_25"
                       {% if d.teaching_top_25 %}checked{% endif %}>
            </td>
            <td>
                <input type="checkbox" class="dept-checkbox" data-field="teaching_65_25"
                       {% if d.teaching_65_25 %}checked{% endif %}>
            </td>
            <td>
                <input type="checkbox" class="dept-checkbox" data-field="teacher_of_year"
                       {% if d.teacher_of_year %}checked{% endif %}>
            </td>
            <td>
                <input type="checkbox" class="dept-checkbox" data-field="honorable_mention"
                       {% if d.honorable_mention %}checked{% endif %}>
            </td>
            <td>
                <input type="checkbox" class="dept-checkbox" data-field="is_ccc_member"
                       {% if d.faculty.is_ccc_member %}checked{% endif %}>
            </td>
            <td class="points-cell" data-points-cell>{{ d.departmental_total_points }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="11" style="text-align: center; color: #666;">
                No faculty data. <a href="{% url 'import_survey' %}">Import survey data</a> first.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

{% block scripts %}
<script>
const yearCode = '{{ academic_year.year_code }}';
const csrfToken = '{{ csrf_token }}';

function updateField(email, field, value) {
    fetch('{% url "departmental_update" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            email: email,
            year_code: yearCode,
            field: field,
            value: value,
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the points cell
            const row = document.querySelector(`tr[data-email="${email}"]`);
            const pointsCell = row.querySelector('[data-points-cell]');
            if (pointsCell) {
                pointsCell.textContent = data.departmental_total_points;
            }
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(err => {
        console.error('Error:', err);
    });
}

// Checkbox handlers
document.querySelectorAll('.dept-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const row = this.closest('tr');
        const email = row.dataset.email;
        const field = this.dataset.field;
        updateField(email, field, this.checked);
    });
});

// Number input handlers
document.querySelectorAll('.dept-number').forEach(input => {
    input.addEventListener('change', function() {
        const row = this.closest('tr');
        const email = row.dataset.email;
        const field = this.dataset.field;
        let value = parseInt(this.value) || 0;
        if (value > 20) value = 20;
        if (value < 0) value = 0;
        this.value = value;
        updateField(email, field, value);
    });
});
</script>
{% endblock %}
